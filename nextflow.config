#!/usr/bin/env nextflow

/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    MWAX-Processing-Pipeline Nextflow config file
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Default config options for all compute environments
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

// Global default params
params {
    help = false
    examples = false
    
    // Downloading .............................................................
    skip_download = false  // Skip downloading the data
    calids        = null   // obs IDs of calibrators
    asvo_id_obs   = null   // ASVO ID for VCS observation
    asvo_id_cals  = null   // ASCO ID for calibrator observations
    offset        = null   // Time offset from beginning of observation
    asvo_api_key  = "$MWA_ASVO_API_KEY"   // ASVO API key for recognising user
    giant_squid   = '/opt/cargo/bin/giant-squid'  // Path within docker image

    // Calibration .............................................................
    // General options
    cal_joblist      = null  // list of calibration jobs
    obsid            = null  // ObsID of VCS observation to calibrate
    calibrators      = null  // Comma separated list of CALID:SOURCE
    // Birli options
    force_birli      = false  // Force Birli to run
    skip_birli       = false  // Force Birli not to run
    df               = 40  // Desired freq. resolution in kHz
    dt               = 2   // Desired time resolution in seconds
    // Hyperdrive options
    flagged_tiles      = ''           // Space separated list of tiles to flag
    flagged_fine_chans = '0 1 30 31'  // Space separated list of fine channels to flag per coarse channel

    // Beamforming and post-processing .........................................
    // General options
    skip_bf           = false  // Skip beamforming and just fold
    // VCSBeam options
    fits              = false  // Export PSRFITS data
    vdif              = false  // Export VDIF data
    low_chan          = 109    // Lowest coarse channel
    num_chan          = 24     // Number of coarse channels
    duration          = null   // Observation length
    begin             = null   // Start GPS time
    calid             = null   // ObsID of calibration observation
    psrs              = null   // List of pulsars to beamform on
    pointings         = null   // List of pointings to beamform
    pointings_file    = null   // File with pointings to beamform on
    convert_rts_flags = false  // Convert tile indices to TileNames
    // Folding and dedispersion options
    nbin        = 128  // Maximum bins to fold into (dspsr & prepfold)
    fine_chan   = 32   // Number of fine channels per coarse channel (dspsr)
    tint        = 8    // Sub-integration time in seconds (dspsr)
    force_psrcat = false
    // Search options
    nosearch_prepfold   = false  // Do not run prepfold search
    nosearch_pdmp       = false  // Do not run pdmp search
    nsub                = 192    // Number of sub-bands to use in prepfold search
    npart               = 256    // Number of sub-integrations to use in prepfold search
    pdmp_mc             = 192    // Maximum number of frequency channels to use in pdmp search
    pdmp_ms             = 256    // Maximum number of sub-integrations to use in pdmp search
    // Acacia upload options
    acacia_profile      = 'mwavcs'
    acacia_bucket       = 'smart'
    acacia_prefix_base  = null  // Will save to ${acacia_prefix_base}/${obsid}
}

def hostname = 'hostname'.execute().text.trim().replace("-", "")
if ( hostname.startsWith('garrawarla') ) {
    // Default file paths
    includeConfig 'conf/pawsey.config'
    // Cluster-specific resource allocation
    includeConfig 'conf/garrawarla.config'
} else {
    System.err.println("ERROR: Pipeline must be executed on Garrawarla.")
    exit(1)
}
