#!/usr/bin/env nextflow

// ------------------------------- GENERAL CONFIG ------------------------------
// Default directories
params.vcs_dir    = '/astro/mwavcs/vcs'
params.asvo_dir   = '/astro/mwavcs/asvo'
params.module_dir = '/pawsey/mwa/software/python3/modulefiles'
workDir           = "/astro/mwavcs/${USER}/mwax_quicklook_work"

// ------------------------------- MWAX_DOWNLOAD -------------------------------
// ASVO IDs for specifying download folders
params.asvo_id_obs  = null
params.asvo_id_cal1 = null
params.asvo_id_cal2 = null

// Download folders
params.download_dir_obs  = "${params.asvo_dir}/${params.asvo_id_obs}"
params.download_dir_cal1 = "${params.asvo_dir}/${params.asvo_id_cal1}"
params.download_dir_cal2 = "${params.asvo_dir}/${params.asvo_id_cal2}"

// ------------------------------- MWAX_CALIBRATE ------------------------------
// Observation identifiers
params.obsid  = null  // ObsID of VCS observation to calibrate
params.calids = null  // Comma separated list of calibrator obsIDs

// Desired frequency and time resolution of calibration UVFITS
params.df = 40  // Freq. resolution in kHz
params.dt = 2   // Time resolution in seconds

// Hyperdrive inputs
params.source        = null  // Source for calibrators
params.flagged_tiles = null  // Comma separated list of tiles to flag

// ------------------------------- RESOURCE SETUP ------------------------------
process {
    cache = 'lenient'

    withLabel: 'gpu|cpu' {
        executor = 'slurm'
        cpus = 1
        memory = '370 GB'
    }
    withLabel: gpu {
        queue   = 'gpuq'
    }
    withLabel: cpu {
        queue   = 'workq'
    }
    withLabel: birli {
        scratch = '/nvmetmp'
        beforeScript = "module use ${params.module_dir}; module load birli"
        clusterOptions = { "--export=NONE" }
    }
    withLabel: hyperdrive {
        scratch = '/nvmetmp'
        beforeScript = "module use ${params.module_dir}; module load hyperdrive"
        clusterOptions = { "--gres=tmp:50g,gpu:1  --export=NONE" }
    }
}